---
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";

import SpeedInsights from "@vercel/speed-insights/astro";
import Analytics from "@vercel/analytics/astro";

interface Props {
    title: string;
    description?: string;
    image?: string;
    type?: "website" | "article";
}

const {
    title,
    description = "Transforme seu negócio com Agentes de IA que atendem, qualificam e vendem 24/7 no WhatsApp.",
    image = "/images/og-image.svg",
    type = "website",
} = Astro.props;

const canonicalURL = new URL(
    Astro.url.pathname,
    Astro.site || "https://brjoy.com.br",
);
---

<!doctype html>
<html lang="pt-BR">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>{title}</title>
        <meta name="description" content={description} />
        <link rel="canonical" href={canonicalURL} />

        <!-- Open Graph / Facebook -->
        <meta property="og:type" content={type} />
        <meta property="og:url" content={canonicalURL} />
        <meta property="og:title" content={title} />
        <meta property="og:description" content={description} />
        <meta property="og:image" content={new URL(image, canonicalURL)} />

        <!-- Twitter -->
        <meta property="twitter:card" content="summary_large_image" />
        <meta property="twitter:url" content={canonicalURL} />
        <meta property="twitter:title" content={title} />
        <meta property="twitter:description" content={description} />
        <meta property="twitter:image" content={new URL(image, canonicalURL)} />

        <!-- Favicon -->
        <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
        <link rel="alternate icon" type="image/webp" href="/favicon.webp" />

        <!-- Critical CSS Inline (Above-the-fold) -->
        <style>
            * {
                box-sizing: border-box;
                margin: 0;
                padding: 0;
            }
            html {
                overflow-x: hidden;
                max-width: 100vw;
            }
            body {
                font-family:
                    "Plus Jakarta Sans",
                    -apple-system,
                    BlinkMacSystemFont,
                    "Segoe UI",
                    sans-serif;
                background-color: #ffffff;
                color: #202124;
                line-height: 1.5;
                -webkit-font-smoothing: antialiased;
                overflow-x: hidden;
                max-width: 100vw;
                width: 100%;
            }
            .container {
                max-width: 1440px;
                margin: 0 auto;
                padding: 0 24px;
                width: 100%;
            }
            /* Prevent Material Icons FOUC - Critical Inline CSS */
            .material-symbols-outlined {
                font-family: "Material Symbols Outlined", sans-serif;
                font-weight: normal;
                font-style: normal;
                line-height: 1;
                letter-spacing: normal;
                text-transform: none;
                display: inline-block;
                white-space: nowrap;
                word-wrap: normal;
                direction: ltr;
                -webkit-font-feature-settings: "liga";
                -webkit-font-smoothing: antialiased;
                user-select: none;
            }
        </style>

        <!-- Preconnect for Performance -->
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />

        <!-- Google Fonts - Async Load with font-display: swap -->
        <link
            rel="preload"
            href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap"
            as="style"
            onload="this.onload=null;this.rel='stylesheet'"
        />
        <noscript
            ><link
                href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap"
                rel="stylesheet"
            /></noscript
        >

        <!-- Material Symbols - Blocking Load to prevent FOUC -->
        <link
            rel="stylesheet"
            href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&display=block"
        />

        <!-- Global Styles -->
        <style is:global>
            @import "../styles/variables.css";
            @import "../styles/base.css";
            @import "../styles/buttons.css";
            @import "../styles/hero.css";
        </style>

        <!-- Schema.org JSON-LD -->
        <script type="application/ld+json">
            {
                "@context": "https://schema.org",
                "@type": "Organization",
                "name": "BrJoy AI",
                "url": "https://brjoy.com.br",
                "logo": "https://brjoy.com.br/images/logo.png",
                "description": "Agentes de IA que atendem, qualificam e vendem 24/7 no WhatsApp para imobiliárias e negócios.",
                "contactPoint": {
                    "@type": "ContactPoint",
                    "telephone": "+55-11-99788-9281",
                    "contactType": "sales",
                    "areaServed": "BR",
                    "availableLanguage": "Portuguese"
                },
                "sameAs": [
                    "https://instagram.com/brjoy.ai",
                    "https://linkedin.com/company/brjoy-ai"
                ]
            }
        </script>

        <!-- Google Analytics - Lazy Load -->
        <script>
            // Aguardar interação do usuário para carregar analytics
            let analyticsLoaded = false;

            function loadAnalytics() {
                if (analyticsLoaded) return;
                analyticsLoaded = true;

                const script = document.createElement("script");
                script.async = true;
                script.src =
                    "https://www.googletagmanager.com/gtag/js?id=G-9LB0M4KF40";
                document.head.appendChild(script);

                script.onload = function () {
                    window.dataLayer = window.dataLayer || [];
                    function gtag() {
                        dataLayer.push(arguments);
                    }
                    gtag("js", new Date());
                    gtag("config", "G-9LB0M4KF40");
                };

                // Remover listeners
                window.removeEventListener("scroll", loadAnalytics);
                window.removeEventListener("mousemove", loadAnalytics);
                window.removeEventListener("click", loadAnalytics);
            }

            // Carregar após primeira interação
            window.addEventListener("scroll", loadAnalytics, {
                once: true,
                passive: true,
            });
            window.addEventListener("mousemove", loadAnalytics, {
                once: true,
                passive: true,
            });
            window.addEventListener("click", loadAnalytics, { once: true });

            // Fallback: carregar após 3s mesmo sem interação
            setTimeout(loadAnalytics, 3000);

            // Global handler for BrChat triggers
            document.addEventListener("click", (e) => {
                const target = e.target.closest('a[href="#open-chat"]');
                if (target) {
                    e.preventDefault();
                    if (window.brformWidget) {
                        window.brformWidget.toggle();
                    } else {
                        console.warn("BrChat widget not initialized");
                    }
                }
            });
        </script>
    </head>
    <body>
        <!-- Header Global em todas as páginas -->
        <Header />

        <!-- Conteúdo da página -->
        <slot />

        <!-- Footer Global em todas as páginas -->
        <Footer />
        <SpeedInsights />
        <Analytics />
    </body>
</html>
